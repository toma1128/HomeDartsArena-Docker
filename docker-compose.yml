services:

  #フロントエンド - React
  frontend:
    container_name: React
    build:
      context: ../frontend
      dockerfile: ../docker/frontend/Dockerfile
    ports:
      - ${FRONTEND_PORT}:5173
    volumes:
      - ../frontend:/app
      - /app/node_modules
    env_file:
      - ../frontend/.env
    command: npm run dev -- --host 0.0.0.0

  #バックエンド - Hono
  backend:
    container_name: Hono
    build:
      context: ../backend
      dockerfile: ../docker/backend/Dockerfile
    ports:
      - ${BACKEND_PORT}:${BACKEND_PORT}
    volumes:
      - ../backend:/app
      - /app/node_modules
    env_file:
      - ../backend/.env
    command: bun run dev
    depends_on:
      - tidb-server

  #認証サーバー - Hono
  auth:
    container_name: Auth
    build:
      context: ../auth
      dockerfile: ../docker/auth/Dockerfile
    ports:
      - ${AUTH_PORT}:${AUTH_PORT}
    volumes:
      - ../auth:/app
      - /app/node_modules
    env_file:
      - ../auth/.env
    command: bun run dev
    depends_on:
      - tidb-server

  #Placement Driver - PD 指揮役
  pd-server:
    container_name: PD
    image: pingcap/pd:latest
    ports:
      - ${PD_PORT}:${PD_PORT} #クライアント用
      - ${PD_PEER_PORT}:${PD_PEER_PORT} #ピア用
    volumes:
      - pd-data:/data
    env_file:
      - ./.env
    command:
      - "--name=pd-server"
      - "--client-urls=http://0.0.0.0:${PD_PORT}"
      - "--peer-urls=http://0.0.0.0:${PD_PEER_PORT}"
      - "--advertise-client-urls=http://pd-server:${PD_PORT}"
      - "--advertise-peer-urls=http://pd-server:${PD_PEER_PORT}"
      - "--initial-cluster=pd-server=http://pd-server:${PD_PEER_PORT}"

  #Key-Valueデータベース - TiKV 実際のデータを保存する場所
  tikv-server:
    container_name: TiKV
    image: pingcap/tikv:latest
    ports:
      - ${TIKV_PORT}:${TIKV_PORT}
    volumes:
      - tikv-data:/data
    env_file:
      - ./.env
    command:
      - "--addr=0.0.0.0:${TIKV_PORT}"
      - "--advertise-addr=tikv-server:${TIKV_PORT}"
      - "--pd=pd-server:${PD_PORT}"
    depends_on:
      - pd-server

  #TiDB - TiDB SQL窓口
  tidb-server:
    container_name: TiDB
    image: pingcap/tidb:v7.5.7
    ports:
      - ${DB_PORT}:${DB_PORT}
      - ${DB_DASHBOARD_PORT}:${DB_DASHBOARD_PORT}
    volumes:
      - tidb-data:/tmp/tidb
    env_file:
      - ./.env
    environment:
      - TZ=Asia/Tokyo
      - MYSQL_ROOT_PASSWORD=${ROOT_PASS}
    command:
      - "--store=tikv"
      - "--path=pd-server:${PD_PORT}"
      - "-P"
      - "${DB_PORT}"
    depends_on:
      - tikv-server
      - pd-server

  db-init:
    image: mariadb:10.5
    container_name: DB-Init
    command: >
      bash -c "
        echo 'Waiting 20s for TiDB to start...'
        sleep 20
        
        echo 'Installing dependencies...'
        apt-get update && apt-get install -y gettext-base
        
        echo 'Preparing init script...'
        envsubst < /docker-entrypoint-initdb.d/init-db.sql > /tmp/init.sql
        
        echo 'Running init script (connecting without password)...'
        # パスワードなしで接続を試みる (最大10回リトライ)
        for i in {1..10}; do
          mysql -h tidb-server -P ${DB_PORT} -u root < /tmp/init.sql && break
          echo 'Retry $i: Connection failed (maybe TiDB is not ready yet?), waiting 5s...'
          sleep 5
        done
        
        echo 'Init script finished.'
      "
    env_file:
      - ./.env
    volumes:
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    depends_on:
      - tidb-server

volumes:
  pd-data:
  tikv-data:
  tidb-data: